events {
    worker_connections 1024;
}

http {
    upstream frontendv2 {
        server frontendv2:3000;
    }

    upstream nestjs-api {
        server nestjs-api:3003;
    }

    upstream legacy-frontend {
        server legacy-frontend:3000;
    }

    upstream legacy-api {
        server legacy-api:3000;
    }

    # Main frontend (new Nuxt 3)
    server {
        listen 80;
        server_name localhost;

        # API routes go to NestJS
        location /api/ {
            proxy_pass http://nestjs-api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Legacy API routes (fallback)
        location /legacy-api/ {
            proxy_pass http://legacy-api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Legacy frontend (accessible at /legacy)
        location /legacy/ {
            proxy_pass http://legacy-frontend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # All other routes go to new frontend
        location / {
            proxy_pass http://frontendv2/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}